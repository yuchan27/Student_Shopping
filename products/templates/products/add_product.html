{% extends 'base.html' %}

{% block content %}
<style>
    /* ä½¿ç”¨ ID (#id_description) åŠ ä¸Š !importantï¼Œé€™æ˜¯ CSS ä¸­æœ€å¼·çš„å‘½ä»¤ */
    
    /* 1. æ§åˆ¶è¼¸å…¥æ¡†æœ¬é«” (èƒŒæ™¯æ·±è—ã€æ‰“å­—è®Šç™½) */
    #id_description {
        background-color: #1c3b63 !important; /* è·Ÿä½ çš„èƒŒæ™¯åœ–ä¸€æ¨£çš„æ·±è— */
        color: #ffffff !important;            /* ä½¿ç”¨è€…æ‰“çš„å­—è®Šç™½è‰² */
        border: 1px solid #5c7cfa !important; /* é‚Šæ¡†äº®ä¸€é» */
    }

    /* 2. æ§åˆ¶æç¤ºæ–‡å­— (Placeholder) é¡è‰² */
    #id_description::placeholder {
        color: #cfd8dc !important;  /* æ¥µäº®çš„æ·ºç°è‰²ï¼Œç¢ºä¿çœ‹å¾—åˆ° */
        opacity: 1 !important;      /* å¼·åˆ¶ä¸é€æ˜ */
    }

    
</style>
<div class="container-fluid py-5 px-lg-5"> 
    <div class="row justify-content-center g-4 align-items-start">
        
        <div class="col-auto">
            <div class="card shadow-sm mb-4 main-form-card">
                <div class="card-header bg-warning text-dark fw-bold text-center py-3 rounded-top-4">
                    <h4 class="mb-0"><i class="bi bi-plus-lg"></i> ä¸Šæ¶æ–°å•†å“</h4>
                </div>
                
                <div class="card-body p-4 flat-top">
                    <form method="post" enctype="multipart/form-data" id="productForm">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label fw-bold">å•†å“åˆ†é¡</label>
                            {{ form.category }} 
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label fw-bold">å•†å“åç¨± / ISBN</label>
                            <div class="input-group">
                                {{ form.name }}
                                <button type="button" class="btn btn-outline-dark text-white" onclick="searchBookInfo(this)">
                                    ğŸ” æŸ¥è©¢
                                </button>
                            </div>
                            <div class="form-text text-muted">
                                è¼¸å…¥åç¨±å¾Œé»æ“ŠæŸ¥è©¢ï¼Œå³å´é¡¯ç¤ºè¡Œæƒ…ã€‚
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.price.id_for_label }}" class="form-label fw-bold">åƒ¹æ ¼ (NT$)</label>
                            {{ form.price }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.stock.id_for_label }}" class="form-label fw-bold">åº«å­˜æ•¸é‡</label>
                            {{ form.stock }}
                        </div>

                        <div class="mb-3"> 
                            <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">å•†å“æè¿°</label>
                            {{ form.description }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.image.id_for_label }}" class="form-label fw-bold">å•†å“åœ–ç‰‡</label>
                            {{ form.image }}
                            <div class="form-text text-muted">æ”¯æ´ jpg, png æ ¼å¼</div>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">ç¢ºèªä¸Šæ¶</button>
                            <a href="/" class="btn btn-outline-secondary">å–æ¶ˆ</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-auto d-none" id="referenceSection">
            <div class="sticky-top" style="top: 20px; z-index: 100;">
                
                <div class="card shadow-sm bg-light border-0 mb-3 reference-card">
                    <div class="card-header bg-secondary text-white fw-bold py-2 rounded-top-4">
                        <i class="bi bi-graph-up-arrow"></i> å¸‚å ´è¡Œæƒ…åƒè€ƒ
                        <button type="button" class="btn-close btn-close-white float-end" onclick="closeReference()" aria-label="Close"></button>
                    </div>
                    <div class="card-body p-2 flat-top" style="max-height: 60vh; overflow-y: auto;">
                        <p class="small text-muted mb-2 text-center" id="searchMsg">
                            æœå°‹çµæœ...
                        </p>
                        <div id="referenceList" class="d-flex flex-column gap-2">
                            </div>
                    </div>
                </div>

                <div id="selectedInfoBox" class="reference-info-box reference-card d-none">
                    <h5 class="fw-bold border-bottom pb-2 mb-2"><i class="bi bi-info-circle"></i> å·²é¸åƒè€ƒè³‡è¨Š</h5>
                    <div id="selectedInfoContent"></div>
                </div>

            </div>
        </div>

    </div>
</div>

<script>
// === 1. è‡ªå‹•èª¿æ•´ textarea é«˜åº¦ ===
document.addEventListener("DOMContentLoaded", function() {
    const tx = document.getElementById('id_description'); 
    if (tx) {
        tx.classList.add('auto-expand');
        tx.style.height = 'auto';
        tx.style.height = (tx.scrollHeight) + 'px';
        
        tx.addEventListener("input", function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + "px";
        });
    }
});

// === 2. æœå°‹ API é‚è¼¯ ===
let currentSearchResults = [];

function searchBookInfo(btn) {
    const nameInput = document.getElementById('id_name');
    const keyword = nameInput.value.trim();

    if (!keyword) {
        alert('è«‹å…ˆè¼¸å…¥å•†å“åç¨±ï¼');
        nameInput.focus();
        return;
    }

    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'æœå°‹ä¸­...';
    
    // é¡¯ç¤ºå³å´
    const refSection = document.getElementById('referenceSection');
    refSection.classList.remove('d-none'); 
    document.getElementById('referenceList').innerHTML = '<div class="text-center py-4 text-muted">æ­£åœ¨åˆ†æå¸‚å ´åƒ¹æ ¼...</div>';

    const formData = new FormData();
    formData.append('keyword', keyword);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);

    fetch('{% url "products:magic_fill" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;

        if (data.status === 'success' && data.data.length > 0) {
            currentSearchResults = data.data; 
            renderReferenceList(data.data);
            document.getElementById('searchMsg').innerText = `âœ… æ‰¾åˆ° ${data.data.length} ç­†è³‡æ–™`;
        } else {
            document.getElementById('referenceList').innerHTML = 
                '<div class="alert alert-warning text-center">âŒ æ‰¾ä¸åˆ°å•†å“</div>';
        }
    })
    .catch(error => {
        console.error(error);
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function renderReferenceList(items) {
    const container = document.getElementById('referenceList');
    container.innerHTML = ''; 

    items.forEach((item, index) => {
        const cardHtml = `
            <div class="card border-0 shadow-sm">
                <div class="row g-0 align-items-center">
                    <div class="col-3 p-2 text-center">
                        <img src="${item.image}" class="img-fluid rounded" style="max-height: 60px; object-fit: contain;" alt="åœ–">
                    </div>
                    <div class="col-9">
                        <div class="card-body p-2">
                            <h6 class="card-title text-truncate mb-1" style="font-size: 0.9rem;">
                                ${item.title}
                            </h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-danger fw-bold">$${item.price}</span>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyData(${index})">
                                    å¸¶å…¥ <i class="bi bi-arrow-left"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += cardHtml;
    });
}

// === 3. å¸¶å…¥è³‡æ–™èˆ‡è‡ªå‹•åˆ†é¡ ===
function applyData(index) {
    const item = currentSearchResults[index];
    if (!item) return;

    // å¸¶å…¥åƒ¹æ ¼
    const priceField = document.getElementById('id_price');
    priceField.value = item.price; 
    flashField(priceField);

    // å¸¶å…¥åç¨± & è§¸ç™¼è‡ªå‹•åˆ†é¡
    const nameField = document.getElementById('id_name');
    if (confirm(`å°‡åç¨±æ›´æ”¹ç‚ºï¼š\n"${item.title}" å—ï¼Ÿ`)) {
        nameField.value = item.title;
        flashField(nameField);

        // [è£œå›] è§¸ç™¼è‡ªå‹•åˆ†é¡
        autoSelectCategory(item.title);
    }

    // æ›´æ–°å³ä¸‹è§’é»ƒè‰²è³‡è¨Šæ¡†
    const infoBox = document.getElementById('selectedInfoBox');
    const infoContent = document.getElementById('selectedInfoContent');
    
    infoBox.classList.remove('d-none');
    infoContent.innerHTML = `
        <p class="mb-1"><strong>å“åï¼š</strong> ${item.title}</p>
        <p class="mb-1"><strong>åƒè€ƒå¸‚åƒ¹ï¼š</strong> <span class="text-danger">$${item.price}</span></p>
        <p class="mb-2"><strong>ä¾†æºï¼š</strong> ${item.source}</p>
        <div class="border-top pt-2 mt-2">
            <p class="mb-0 text-danger fw-bold small">
                <i class="bi bi-asterisk"></i> è«‹ä¾ç…§å•†å“åƒè€ƒåƒ¹æ ¼åšå‡ºèª¿æ•´
            </p>
        </div>
    `;
}

// è‡ªå‹•åˆ†é¡é‚è¼¯å‡½å¼
function autoSelectCategory(title) {
    const categorySelect = document.getElementById('id_category'); 
    if (!categorySelect) return;

    const lowerTitle = title.toLowerCase();
    let targetKeyword = [];

    // === é—œéµå­—è¨­å®šå€ (è«‹ä¾æ‚¨è³‡æ–™åº«çœŸå¯¦åˆ†é¡èª¿æ•´) ===
    if (lowerTitle.match(/iphone|å°ç±³|ç´…ç±³/)) {
        targetKeyword = ["æ‰‹æ©Ÿ"]; 
    } 
    else if (lowerTitle.match(/mac|asus|acer|å¾®æ˜Ÿ|ç¾…æŠ€|éµç›¤|æ»‘é¼ |è€³æ©Ÿ|airpods|ipad|å¹³æ¿|é›»è…¦|ç­†é›»/)) {
        targetKeyword = ["3C"];
    }  
    else if (lowerTitle.match(/å†°ç®±|ç©ºæ°£æ¸…æ·¨æ©Ÿ|é™¤æ¿•æ©Ÿ|é¢¨æ‰‡/)) {
        targetKeyword = ["å®¶é›»"];
    } 
    else if (lowerTitle.match(/python|java|c\+\+|å¾®ç©åˆ†|ç¶“æ¿Ÿå­¸|èª²æœ¬|åƒè€ƒæ›¸|å¤šç›Š|æª¢å®š|å°èªª|æ¼«ç•«/)) {
        targetKeyword = ["åœ–æ›¸"];
    }
    else if (lowerTitle.match(/è¡£|è¤²|é‹|å¸½|åŒ…|è£™|å¤–å¥—/)) {
        targetKeyword = ["æœé£¾"];
    }
    else if (lowerTitle.match(/è¡›ç”Ÿç´™|æ¡Œ|æ¤…|æ«ƒ|ç‡ˆ|é¢¨æ‰‡|å¹é¢¨æ©Ÿ/)) {
        targetKeyword = ["å®¶å…·"];
    }
    else if (lowerTitle.match(/é£²æ–™|é£Ÿç‰©|èª¿ç†åŒ…/)) {
        targetKeyword = ["é£Ÿå“"];
    }else {
        targetKeyword = ["é›œé …"];
    }

    // åŸ·è¡Œæ¯”å°èˆ‡é¸å–
    if (targetKeyword.length > 0) {
        for (let i = 0; i < categorySelect.options.length; i++) {
            const optionText = categorySelect.options[i].text;
            const isMatch = targetKeyword.some(k => optionText.includes(k));
            
            if (isMatch) {
                categorySelect.selectedIndex = i;
                flashField(categorySelect);
                console.log(`å·²è‡ªå‹•åˆ†é¡è‡³: ${optionText}`);
                break; 
            }
        }
    }
}

function flashField(element) {
    element.style.transition = "background-color 0.3s";
    element.style.backgroundColor = "#d1e7dd"; 
    setTimeout(() => {
        element.style.backgroundColor = "";
    }, 1000);
}

function closeReference() {
    document.getElementById('referenceSection').classList.add('d-none');
}
</script>
{% endblock %}