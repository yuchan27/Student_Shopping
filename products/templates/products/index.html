{% extends 'base.html' %}
{% load static %}

{% block content %}


{# --- 1. æ­¡è¿å€å¡Š (Hero Section) --- #}
{% if not user.is_authenticated %}
<div class="p-5 mb-4 rounded-3 shadow-lg text-center border-0 hero-glass mx-3 mt-3">
    <div class="container-fluid py-3">
        <h1 class="display-5 fw-bold text-white title-glow">æ­¡è¿ä¾†åˆ°å¤§å­¸ç”ŸShopping! ğŸ‘‹</h1>
        <p class="col-md-8 fs-4 mx-auto text-light opacity-75">
            å°ˆå±¬å¤§å­¸ç”Ÿçš„äºŒæ‰‹äº¤æ˜“å¹³å°ï¼Œä½¿ç”¨å­¸æ ¡ä¿¡ç®±å³å¯å¿«é€Ÿé©—è­‰ã€‚
            è¶•å¿«åŠ å…¥æˆ‘å€‘ï¼Œå‡ºæ¸…ä½ çš„èˆŠèª²æœ¬èˆ‡å®¿èˆé›œç‰©ï¼
        </p>
        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mt-4">
            <a href="{% url 'users:register' %}" class="btn btn-shopee btn-lg px-4 gap-3 shadow">ğŸš€ ç«‹å³è¨»å†Šæœƒå“¡</a>
            <a href="{% url 'login' %}" class="btn btn-outline-light btn-lg px-4">æœƒå“¡ç™»å…¥</a>
        </div>
    </div>
</div>
{% endif %}

<div class="container-fluid px-4">
    {# --- 2. æ¨™é¡Œå€ --- #}
    <div class="row mb-4 align-items-center mt-4">
        <div class="col-md-8">
            {% if query %}
                <h2 class="text-white border-start border-4 ps-3 border-info title-glow">
                    ğŸ” æœå°‹çµæœï¼š{{ query }}
                    <span class="badge bg-warning text-dark fs-6 ms-2 align-middle shadow">
                        {{ search_type|default:"ä¸€èˆ¬æœå°‹" }}
                    </span>
                </h2>
            {% elif current_category %}
                 <h2 class="text-white border-start border-4 ps-3 border-info title-glow">ğŸ“‚ åˆ†é¡ç€è¦½</h2>
            {% else %}
                <h2 class="text-white border-start border-4 ps-3 border-info title-glow">ğŸ”¥ ç†±é–€æ¨è–¦å•†å“</h2>
            {% endif %}
        </div>
    </div>

    <div class="row g-4">
        {# --- 3. å·¦å´åˆ†é¡æ¬„ (col-lg-2) --- #}
        <div class="col-lg-2 mb-4 d-none d-lg-block">
            <div class="list-group shadow-sm sticky-top" style="top: 100px; z-index: 5;">
                <div class="list-group-item fw-bold border-bottom-0 py-3" style="background: var(--shopee-purple-dark);">
                    <i class="bi bi-grid-fill"></i> å•†å“åˆ†é¡
                </div>
                
                <a href="{% url 'products:index' %}" 
                   class="list-group-item list-group-item-action {% if not current_category %}active-category{% endif %}">
                    å…¨éƒ¨å•†å“
                </a>

                {% for cat in categories %}
                <a href="{% url 'products:index' %}?category={{ cat.id }}" 
                   class="list-group-item list-group-item-action {% if current_category|stringformat:'s' == cat.id|stringformat:'s' %}active-category{% endif %}">
                    {{ cat.name }}
                </a>
                {% endfor %}
            </div>
        </div>

        {# --- 4. ä¸­é–“å•†å“åˆ—è¡¨å€ (col-lg-7) --- #}
        <div class="col-lg-7">
            
            <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded hero-glass">
                <span class="text-neon small fw-bold ms-2">
                    <i class="bi bi-box-seam"></i> å…±æ‰¾åˆ° {{ products|length }} æ¨£å•†å“
                </span>

                <form method="GET" class="d-flex align-items-center">
                    {% if current_category %}
                        <input type="hidden" name="category" value="{{ current_category }}">
                    {% endif %}
                    {% if query %}
                        <input type="hidden" name="q" value="{{ query }}">
                    {% endif %}

                    <label for="sort" class="me-2 text-nowrap small text-white fw-bold">æ’åºï¼š</label>
                    <select name="sort" id="sort" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
                        <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>æœ€æ–°ä¸Šæ¶</option>
                        <option value="price_asc" {% if current_sort == 'price_asc' %}selected{% endif %}>åƒ¹æ ¼ï¼šä½ â†’ é«˜</option>
                        <option value="price_desc" {% if current_sort == 'price_desc' %}selected{% endif %}>åƒ¹æ ¼ï¼šé«˜ â†’ ä½</option>
                    </select>
                </form>
            </div>

            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
                {% for product in products %}
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="product-img-wrapper">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.name }}">
                            {% else %}
                                <i class="bi bi-box-seam display-1 text-secondary"></i>
                            {% endif %}
                            
                            {% if product.stock == 0 %}
                            <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(0,0,0,0.7);">
                                <span class="badge bg-danger fs-3 shadow">å·²å”®å®Œ</span>
                            </div>
                            {% endif %}
                        </div>

                        <div class="card-body d-flex flex-column flat-top">
                            <div class="mb-2">
                                {% if product.category %}
                                    <span class="badge bg-info text-dark mb-2">{{ product.category.name }}</span>
                                {% endif %}
                                <h5 class="card-title text-truncate fw-bold">
                                    {% if product.stock > 0 %}
                                        <a href="{% url 'orders:create_order' product.id %}" class="text-decoration-none text-white stretched-link product-link">
                                            {{ product.name }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">{{ product.name }}</span>
                                    {% endif %}
                                </h5>
                            </div>

                            <p class="card-text fw-bold fs-4 price-text">${{ product.price }}</p>
                            
                            <div class="mt-auto">
                                <p class="card-text text-muted small mb-2">
                                    <i class="bi bi-shop"></i> {{ product.shop.name|default:"ç„¡åå•†åº—"|truncatechars:10 }} <br>
                                    åº«å­˜: {{ product.stock }}
                                </p>

                                <div class="d-flex flex-column gap-2 position-relative" style="z-index: 2;">
                                    {% if product.stock > 0 %}
                                        <a href="{% url 'orders:add_to_cart' product.id %}" class="btn btn-outline-light btn-sm w-100">
                                            åŠ å…¥è³¼ç‰©è»Š <i class="bi bi-cart-plus"></i>
                                        </a>
                                        <a href="{% url 'orders:create_order' product.id %}" class="btn btn-shopee btn-sm w-100 fw-bold">
                                            ç«‹å³è³¼è²·
                                        </a>
                                    {% else %}
                                        <button type="button" class="btn btn-secondary w-100" disabled>è£œè²¨ä¸­</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5">
                    <div class="alert hero-glass text-warning border-warning" role="alert">
                        {% if query %}
                            <h4>æ‰¾ä¸åˆ°ç¬¦åˆã€Œ{{ query }}ã€çš„å•†å“ ğŸ˜…</h4>
                            <p>è«‹è©¦è©¦çœ‹å³é‚Šçš„ã€Œå¤–éƒ¨è¡Œæƒ…æ¯”åƒ¹ã€ï¼</p>
                        {% else %}
                            ç›®å‰é€™å€‹åˆ†é¡é‚„æ²’æœ‰å•†å“ä¸Šæ¶ã€‚
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {# --- 5. å³å´å¤–éƒ¨æ¯”åƒ¹å€ (col-lg-3) --- #}
        <div class="col-lg-3">
            <div class="sticky-top" style="top: 100px; z-index: 1;">
                
                {# === çµ„ä»¶ä¸€ï¼šæœå°‹æ¯”åƒ¹ Widget === #}
                <div class="card border-0 shadow-lg hero-glass overflow-hidden rounded-4 mb-3" 
                    style="border: 1px solid rgba(255,255,255,0.1);">
                    
                    {# æ¨™é¡Œï¼šç´«è‰²æ¼¸å±¤ #}
                    <div class="card-header border-0 py-3 text-white text-center" 
                        style="background: linear-gradient(45deg, #6610f2, #6f42c1);">
                        <h5 class="m-0 fw-bold">
                            <i class="bi bi-globe2 me-2"></i>å¤–éƒ¨è¡Œæƒ…
                        </h5>
                    </div>

                    <div class="card-body p-4 flat-top">
                        {# è¼¸å…¥æ¡†ï¼šåœ“è§’è† å›Šè¨­è¨ˆ #}
                        <div class="input-group mb-3 shadow-sm">
                            <input type="text" id="externalSearchInput" 
                                class="form-control border-0 rounded-pill-start" 
                                style="background: rgba(255,255,255,0.9);"
                                placeholder="åˆ¥äººè³£å¤šå°‘éŒ¢..." 
                                value="{{ query|default:'' }}">
                            <button class="btn btn-warning fw-bold text-dark px-3 rounded-pill-end" 
                                    onclick="searchExternalMarket()" 
                                    id="btnExternalSearch">
                                Go
                            </button>
                        </div>

                        {# çµæœé¡¯ç¤ºå€ #}
                        <div id="externalResultsArea" class="d-none animate__animated animate__fadeIn">
                            <div class="d-flex align-items-center mb-2 pb-2 border-bottom border-light border-opacity-25">
                                <span class="badge bg-danger me-2">HOT</span>
                                <span class="text-white small fw-bold">ç¶²è·¯åƒè€ƒåƒ¹</span>
                            </div>
                            <div id="externalResultsList" class="d-flex flex-column gap-2 custom-scrollbar pe-1" 
                                style="max-height: 400px; overflow-y: auto;">
                                </div>
                        </div>

                        {# ç©ºç‹€æ…‹åœ–ç¤º #}
                        <div id="externalDefaultMsg" class="text-center text-muted py-2">
                            <small>è¼¸å…¥é—œéµå­—ï¼Œä¸€éµæ¯”åƒ¹</small>
                        </div>
                    </div>
                </div>

                {# === çµ„ä»¶äºŒï¼šå°æ’‡æ­¥ Widget (ç¨ç«‹æ‡¸æµ®) === #}
                <div class="card border-0 shadow-lg rounded-4 text-white position-relative overflow-hidden" 
                    style="background: linear-gradient(135deg, #FF6B6B, #FF8E53);">
                    
                    <div class="position-absolute top-0 end-0 translate-middle rounded-circle bg-white opacity-10" style="width: 100px; height: 100px;"></div>
                    
                    <div class="card-body p-3 d-flex align-items-center">
                        <div class="flex-shrink-0 bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="bi bi-lightbulb-fill text-white fs-5"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="fw-bold mb-1">å®šåƒ¹å°æ’‡æ­¥</h6>
                            <div class="small opacity-75" style="line-height: 1.2;">
                                åƒè€ƒå¸‚åƒ¹å¾Œå†å®šåƒ¹ï¼Œ<br>å•†å“æˆäº¤ç‡ <span class="fw-bold text-warning" style="text-shadow: 0 1px 2px rgba(0,0,0,0.2);">UP!</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

{# --- Script åŠŸèƒ½ --- #}
<script>
function searchExternalMarket(keyword = null) {
    if (!keyword) {
        const input = document.getElementById('externalSearchInput');
        if (input) {
            keyword = input.value.trim();
        }
    }
    
    if (!keyword) {
        alert('è«‹è¼¸å…¥å•†å“åç¨±ï¼');
        return;
    }

    const btn = document.getElementById('btnExternalSearch');
    const resultArea = document.getElementById('externalResultsArea');
    const listArea = document.getElementById('externalResultsList');
    const defaultMsg = document.getElementById('externalDefaultMsg');
    
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    defaultMsg.classList.add('d-none');
    resultArea.classList.remove('d-none');
    
    listArea.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-light spinner-border-sm"></div><p class="mt-2 small text-muted">æœå°‹ä¸­...</p></div>';

    const formData = new FormData();
    formData.append('keyword', keyword);
    const csrfToken = '{{ csrf_token }}'; 
    formData.append('csrfmiddlewaretoken', csrfToken);

    fetch('{% url "products:magic_fill_product" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;

        if (data.status === 'success' && data.data.length > 0) {
            renderExternalResults(data.data);
        } else {
            listArea.innerHTML = '<div class="text-center text-muted small py-3">âŒ æ‰¾ä¸åˆ°ç›¸é—œè³‡è¨Šã€‚</div>';
        }
    })
    .catch(error => {
        console.error(error);
        btn.disabled = false;
        btn.innerHTML = originalText;
        listArea.innerHTML = '<div class="text-center text-danger small py-3">é€£ç·šéŒ¯èª¤ã€‚</div>';
    });
}

function renderExternalResults(items) {
    const listArea = document.getElementById('externalResultsList');
    listArea.innerHTML = ''; 

    items.forEach(item => {
        // [ä¿®æ”¹é‡é»]ï¼šJS ç”¢ç”Ÿçš„ HTML ä½¿ç”¨æˆ‘å€‘æ–°å®šç¾©çš„ CSS Class
        // åœ¨ renderExternalResults å‡½å¼ä¸­çš„ HTML 
        // è«‹æ›¿æ› renderExternalResults è£¡é¢çš„ html è®Šæ•¸
        // åœ¨ renderExternalResults å‡½å¼ä¸­çš„ HTML
        // åœ¨ renderExternalResults å‡½å¼çš„è¿´åœˆå…§
        // é€™æ˜¯æº–å‚™æ”¾å…¥ #externalResultsList çš„æ¯ä¸€é … HTML
        const html = `
            <div style="
                background: rgba(255, 255, 255, 0.05) !important; 
                border-radius: 12px; 
                margin-bottom: 8px; 
                padding: 12px; 
                display: flex; 
                align-items: center; 
                transition: none !important; 
                box-shadow: none !important;
            ">
                <div style="
                    flex-shrink: 0; 
                    background: white; 
                    border-radius: 8px; 
                    width: 50px; 
                    height: 50px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    padding: 4px;
                ">
                    <img src="${item.image}" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="img">
                </div>
                
                <div style="flex-grow: 1; margin-left: 12px; min-width: 0;">
                    <div style="
                        color: rgba(255,255,255,0.8); 
                        font-size: 0.85rem; 
                        white-space: nowrap; 
                        overflow: hidden; 
                        text-overflow: ellipsis; 
                        margin-bottom: 4px;
                    " title="${item.title}">
                        ${item.title}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <span style="color: #ffc107; font-weight: bold; font-size: 1.1rem;">
                            $${item.price}
                        </span>
                    </div>
                </div>
            </div>
        `;
        listArea.innerHTML += html;
    });
}

// é é¢è¼‰å…¥æ™‚ï¼Œå¦‚æœæœ‰æœå°‹é—œéµå­—ï¼Œè‡ªå‹•åŸ·è¡Œå¤–éƒ¨æœå°‹
document.addEventListener("DOMContentLoaded", function() {
    const query = "{{ query|default:'' }}";
    if (query) {
        searchExternalMarket(query);
    }
});
</script>
{% endblock %}